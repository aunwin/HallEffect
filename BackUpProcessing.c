// Header files                                        //
//-----------------------------------------------------//
#include <cdefBF533.h>
// Header File for using Fractional Data Format in C and
// its special functions 
#include <fract.h>
#include <fract2float_conv.h>
#include "DefConst.h"
//-----------------------------------------------------//


//-----------------------------------------------------//
// Externe Variables                                    //
//-----------------------------------------------------//
extern unsigned char  ChipVer;        // Chip-Realize
extern unsigned int   LEDs;           // LED-Pattern
//-------------------------------
extern fract16        fInp_1;
extern fract16        fInp_2;
extern fract16        fInp_3;
extern fract16        fInp_4;
//-------------------------------
extern fract16        fOut_1;
extern fract16        fOut_2;
extern fract16        fOut_3;
extern fract16        fOut_4;
//-------------------------------
extern int iTxBuffer[];         // SPORT0 DMA transmit buffer
extern int iRxBuffer[];         // SPORT0 DMA receive buffer
//-------------------------------


//---------------------------------------------------------------------------
// Prototypes                                                              //
//---------------------------------------------------------------------------
void  Process_A(void);              // PROCESS_A Signal-Processing 
void  Process_B(void);              // PROCESS_B Signal-Processing 
void  Process_C(void);              // PROCESS_C Signal-Processing 
void  Process_D(void);              // PROCESS_D fSignal-Processing 
//------------------------
void  Process_Tim0(void);           // PROCESS_Timer_0 Signal-Processing  
//---------------------------------------------------------------------------
void  PutDAC(short,fract16);        // Data to DAC
//---------------------------------------------------------------------------



//----------------------------------------------------------------------------
// Function:    PROCESS_A for Signal-Processing                             //
// ---------------------------------------                                  //
// Description:                                                             //
//                                                                          //
//                                                                          //  
//----------------------------------------------------------------------------
void Process_A(void)                // (For Test Only - Talkthrough) 
 { //------------------------
   fOut_1   =  fInp_1;              // Input Buffer
   
   fOut_2   =  fInp_2;              // Input Buffer
   //------------------------
   PutDAC(DAC_1R, fOut_1);  // Write DAC 1R
   PutDAC(DAC_1L, fOut_2);  // Write DAC 1L
   //------------------------
 }
//--------------------------------------------------------------------------//


//--------------------------------------------------------------------------//
// Function:    PROCESS_B for Signal-Processing                             //
// ---------------------------------------                                  //
// Description:                                                             //
//                                                                          //
//                                                                          //  
//--------------------------------------------------------------------------//
void Process_B(void) 
 { 
    /*
    static int index = 0;
    int i;
    
    Buffer_in[index] = fInp_1;
    
    index++;
    if(index == 1024)
    {
        // call to the FIR-DSP library
        fir16(Buffer_in);
        
        index = 0;
    }
    */ 
     
     
     int i;
     // index -> Filtercoef. count
     static int index = 65; 
     float b[index], Buffer_in[index];     
     
    
    b[0]= -0.00145464; 
    b[1]= -0.00008947;
    b[2]= 0.00004033; 
    b[3]= 0.00011522; 
    b[4]= 0.00001408; 
    b[5]= -0.00011556; 
    b[6]= -0.00007208; 
    b[7]= 0.00008710; 
    b[8]= 0.00011954;
    b[9]= -0.00003336; 
    b[10]= -0.00014321; 
    b[11]= -0.00003534; 
    b[12]= 0.00013421; 
    b[13]= 0.00010363; 
    b[14]= -0.00009087; 
    b[15]= -0.00015439; 
    b[16]= 0.00001993; 
    b[17]= 0.00017291; 
    b[18]= 0.00006416; 
    b[19]= -0.00015088; 
    b[20]= -0.00014200; 
    b[21]= 0.00008917; 
    b[22]= 0.00019356; 
    b[23]= 0.00000134; 
    b[24]= -0.00020318; 
    b[25]= -0.00010138;
    b[26]= 0.00016393; 
    b[27]= 0.00018727; 
    b[28]= -0.00008028; 
    b[29]= -0.00023630; 
    b[30]= -0.00003181; 
    b[31]= 0.00023256; 
    b[32]= 0.00014768; 
    b[33]= -0.00017154; 
    b[34]= -0.00023921; 
    b[35]= 0.00006243; 
    b[36]= 0.00028148; 
    b[37]= 0.00007277; 
    b[38]= -0.00025924; 
    b[39]= -0.00020347; 
    b[40]= 0.00017163; 
    b[41]= 0.00029724; 
    b[42]= -0.00003380; 
    b[43]= -0.00032759; 
    b[44]= -0.00012533; 
    b[45]= 0.00028112; 
    b[46]= 0.00026887; 
    b[47]= -0.00016199; 
    b[48]= -0.00036036; 
    b[49]= -0.00000741; 
    b[50]= 0.00037271; 
    b[51]= 0.00019039; 
    b[52]= -0.00029577; 
    b[53]= -0.00034359; 
    b[54]= 0.00014028; 
    b[55]= 0.00042711; 
    b[56]= 0.00006289; 
    b[57]= -0.00041453; 
    b[58]= -0.00026852; 
    b[59]= 0.00030054; 
    b[60]= 0.00042691; 
    b[61]= -0.00010411; 
    b[62]= -0.00049559; 
    b[63]= -0.00013412; 
    b[64]= 0.00045032;
    b[65]= 0.00035994;
    
     
     for(i=0; i < index; i++)
     {
         Buffer_in[index] = 0;
     }
     
     // Repeat for each new sample
     // right shift
     for(i=index-1; i>0; i--)
     {
         Buffer_in[index] = Buffer_in[index-1];
     }
     
     // Write new StartValue
     Buffer_in[0] = fInp_1;
     
     // Calculate new output
     fInp_1 =0;
     for(i=0; i<index; i++)
     {
         fInp_1 += (b[index] * Buffer_in[index]);
     }
     
   
     
   //------------------------ 
   fOut_1   =  fInp_1;              // Input Buffer
   
   fOut_2   =  fInp_2;              // Input Buffer
   //------------------------
   PutDAC(DAC_1R, fOut_1);  // Write DAC 1R
   PutDAC(DAC_1L, fOut_2);  // Write DAC 1L

 }
//--------------------------------------------------------------------------//


//--------------------------------------------------------------------------//
// Function:    PROCESS_C for Signal-Processing                             //
// ---------------------------------------                                  //
// Description:                                                             //
//                                                                          //
//                                                                          //  
//--------------------------------------------------------------------------//
void Process_C(void) 
 {

 }
//--------------------------------------------------------------------------//


//--------------------------------------------------------------------------//
// Function:    PROCESS_D for Signal-Processing                             //
// ---------------------------------------                                  //
// Description:                                                             //
//                                                                          //
//                                                                          //  
//--------------------------------------------------------------------------//
void Process_D(void) 
 {

 }
//--------------------------------------------------------------------------//


//--------------------------------------------------------------------------//
// Function:    Process_Tim0 - Signal-Processing                             //
// ---------------------------------------                                  //
// Description:                                                             //
//                                                                          //
//                                                                          //  
//--------------------------------------------------------------------------//
void Process_Tim0(void) 
 { 

 }
//--------------------------------------------------------------------------//



//-------------------------------------------------------------------------//
void PutDAC(short Port, fract16 fData)  // Data to DAC
 {//-----------------------------------------------------------------------//
   int          iData;
   unsigned int LeftWord,RightWord;
   //-----------------------------------------------------------------
   iData = (int)fData;              // 16 bit signed --> 32 bit signed    
   iData = iData << 8;              // expand 16 bit to 24 bit
   //-----------------------------------------------------------------
   if(ChipVer < 0x02) 
    { //--------------------------------------------------------------
      // DMA-Input anomaly, Chip-Realize 0.1 for EZ-KIT LITE  Rev. 1.1 
      //--------------------------------------------------------------
      LeftWord  = (unsigned int)iData >> 16;
      RightWord = (unsigned int)iData << 16;
      iData = LeftWord | RightWord;
      //------------ 
    } // end if anomaly
   //-----------------------------------------------------------------
   iTxBuffer[Port]=iData;           //  Write DAC
 } // end function PutDAC
//--------------------------------------------------------------------------//
